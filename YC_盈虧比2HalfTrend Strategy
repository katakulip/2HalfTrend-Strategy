//@version=5
//ç›ˆè™§æ¯”2
strategy('YC_ç›ˆè™§æ¯”2HalfTrend Strategy', overlay=true, initial_capital=1000)

// é€‰æ‹©æŠ¥è­¦ç±»å‹ï¼Œé»˜è®¤ä¸º PineConnector ä¹Ÿå¯ä»¥é€‰æ‹© Telegram
tlpc = input.string(title="Alert", defval="PineConnector", options=["PineConnector", "Telegram"], tooltip="Go to alertatron to have alerts automatically sent to Telegram")

 
// è®¾ç½®
// ID: PineConnector çš„è®¸å¯è¯ ID
ID = input("1234567890123", title="License ID (PineConnector)", group="Setting")
// risk: æ¯æ¬¡äº¤æ˜“çš„é£é™©ç™¾åˆ†æ¯”
risk = input.float(2, title="Risk per Trade %", group="Setting", step=0.5)
// typeSL: æ­¢æŸç±»å‹ATR æˆ– Swing
typeSL = input.string(title="StopLoss", defval="ATR", options=["Swing", "ATR"], group="Setting")
// typeTP: æ­¢ç›ˆç±»å‹R:R æˆ– Multiple Target
typeTP = input.string(title="TakeProfit", defval="R:R", options=["R:R", "Multiple Target"], group="Setting")
// trendA: è¶‹åŠ¿æŒ‡æ ‡EMA æˆ– Superichi
trendA = input.string(title="Trend Indicator", defval="EMA", options=["EMA", "Superichi"], group="Setting")
// _x: æ˜¯å¦é¿å…å¤ªå°çš„ä»“ä½ï¼Œç”¨äºé¿å…è¿›åœºç‚¹é è¿‘æ­¢æŸç‚¹ï¼Œä½¿ç»çºªäººçš„ç‚¹å·®åƒæ‰æ‰€æœ‰æ”¶ç›Š
_x = input.bool(false, title="do not take too small positions", group="Setting", tooltip="This parameter is used to avoid positions that have a stoploss too close to the entry point and that the broker's spreads take all the gains")
// security: æœ€å°ç‚¹æ•°ï¼ˆä»¥ pips ä¸ºå•ä½ï¼‰
security = input.float(10, title="min of pips (00001.00)", group="Setting")

// è®¡ç®—é£é™©å€æ•°
riskt = risk / 100 + 1

//Backtest Time Period
// å›æµ‹æ—¶é—´èŒƒå›´
// useDateFilter: æ˜¯å¦å¯¹å›æµ‹æ—¶é—´èŒƒå›´è¿›è¡Œç­›é€‰
useDateFilter = input.bool(false, title="Filter Date Range of Backtest", group="Backtest Time Period")
// backtestStartDate: å›æµ‹å¼€å§‹æ—¥æœŸ
backtestStartDate = input.time(timestamp("1 June 2022"), title="Start Date", group="Backtest Time Period", tooltip="This start date is in the time zone of the exchange " + "where the chart's instrument trades. It doesn't use the time " + "zone of the chart or of your computer.")
// backtestEndDate: å›æµ‹ç»“æŸæ—¥æœŸ
backtestEndDate = input.time(timestamp("1 July 2022"), title="End Date", group="Backtest Time Period", tooltip="This end date is in the time zone of the exchange " + "where the chart's instrument trades. It doesn't use the time " + "zone of the chart or of your computer.")
// inTradeWindow: æ˜¯å¦åœ¨å›æµ‹æ—¶é—´èŒƒå›´å†…
inTradeWindow = not useDateFilter or (time >= backtestStartDate and time < backtestEndDate)

//backtestStartDate = input.time(timestamp("12 July 2022"), title="Start Date", group="Backtest Time Period", tooltip="This start date is in the time zone of the exchange " + "where the chart's instrument trades. It doesn't use the time " + "zone of the chart or of your computer.")
//backtestEndDate = input.time(timestamp("15 November 2022"), title="End Date", group="Backtest Time Period", tooltip="This end date is in the time zone of the exchange " + "where the chart's instrument trades. It doesn't use the time " + "zone of the chart or of your computer.")

//inTradeWindow =  useDateFilter or (time >= backtestStartDate and time < backtestEndDate)


//StopLoss

swingHighV = input.int(7, title="Swing High", group="Stop Loss", tooltip="Number of candles in which the parameter targets the highest")
swingLowV = input.int(7, title="Swing Low", group="Stop Loss", tooltip="Number of candles in which the parameter targets the lowest point")

atr1 = input.int(14, title="ATR Period", group="Stop Loss")
atrMultiplierSL = input.int(2, title = "ATR Multiplier", group="Stop Loss")

atr = ta.atr(atr1)

swingHigh = ta.highest(high, swingHighV)
swingLow = ta.lowest(low, swingLowV)

atrSell = close + atr * atrMultiplierSL
atrBuy = close - atr * atrMultiplierSL

//TakeProfit
//************************************************************************æ›´æ”¹ç›ˆè™§æ¯”defval
target_stop_ratio = input.float(title='Risk/Reward (R:R)', defval=2, minval=0.5, maxval=100, step=0.1, group="TakeProfit")
target1 = input.float(1, title='Target 1 R:R (Multiple Target)', group="TakeProfit", step=0.1)
target2 = input.float(2, title='Target 2 R:R (Multiple Target)', group="TakeProfit", step=0.1)

//HalfTrend
//åˆ†åˆ¥ç‚º â€œæŒ¯å¹…â€ã€â€œé »é“åå·®â€ã€â€œé¡¯ç¤ºç®­é ­â€ å’Œ  â€œé¡¯ç¤ºé »é“â€ä¸¦è¨­å®šé è¨­å€¼ã€‚é€™äº›åƒæ•¸å¯ä»¥è¢«ç”¨ä¾†æ§åˆ¶åœ–è¡¨çš„å¤–è§€å’Œè¡Œç‚ºã€‚
amplitude = input(title='Amplitude', defval=2, group="HalfTrend")
channelDeviation = input(title='Channel Deviation', defval=2, group="HalfTrend")
showArrows = input(title='Show Arrows', defval=true, group="HalfTrend")
showChannels = input(title='Show Channels', defval=true, group="HalfTrend")

//å®ƒåˆå§‹åŒ–äº†ä¸€äº›æ•´æ•¸å’Œæµ®é»æ•¸è®Šé‡ï¼Œä¸¦è¨ˆç®—äº†ä¸€äº›æ•¸å€¼ï¼Œä¾‹å¦‚ç§»å‹•å¹³å‡æ•¸ (SMA) å’Œå¹³å‡çœŸå¯¦æ³¢å¹… (ATR)ã€‚
//å®ƒè¨ˆç®—äº†ä¸€äº›åƒ¹æ ¼å€¼ï¼Œä¾‹å¦‚é«˜åƒ¹ã€ä½åƒ¹ã€é«˜åƒ¹ç§»å‹•å¹³å‡æ•¸å’Œä½åƒ¹ç§»å‹•å¹³å‡æ•¸ï¼Œä¸¦ç”¨é€™äº›å€¼è¨ˆç®—äº†ä¸€äº›æ•¸å€¼ï¼Œä¾‹å¦‚ atr2 å’Œ devã€‚
//é€™æ®µä»£ç¢¼é‚„æ²’æœ‰å®Œå…¨å®šç¾©ï¼Œå› æ­¤ä¸èƒ½å®Œå…¨ç¢ºå®šå®ƒçš„åŠŸèƒ½å’Œæ„ç¾©ã€‚å®ƒéœ€è¦æ›´å¤šçš„ä»£ç¢¼ä¾†å®Œæ•´åœ°å®šç¾©å®ƒçš„è¡Œç‚ºå’Œè¼¸å‡ºã€‚
var int trend = 0
var int nextTrend = 0
var float maxLowPrice = nz(low[1], low)
var float minHighPrice = nz(high[1], high)

var float up = 0.0
var float down = 0.0
float atrHigh = 0.0
float atrLow = 0.0
float arrowUp = na
float arrowDown = na

atr2 = ta.atr(100) / 2
dev = channelDeviation * atr2

highPrice = high[math.abs(ta.highestbars(amplitude))]
lowPrice = low[math.abs(ta.lowestbars(amplitude))]
highma = ta.sma(high, amplitude)
lowma = ta.sma(low, amplitude)

if nextTrend == 1
    maxLowPrice := math.max(lowPrice, maxLowPrice)

    if highma < maxLowPrice and close < nz(low[1], low)
        trend := 1
        nextTrend := 0
        minHighPrice := highPrice
        minHighPrice
else
    minHighPrice := math.min(highPrice, minHighPrice)

    if lowma > minHighPrice and close > nz(high[1], high)
        trend := 0
        nextTrend := 1
        maxLowPrice := lowPrice
        maxLowPrice

if trend == 0
    if not na(trend[1]) and trend[1] != 0
        up := na(down[1]) ? down : down[1]
        arrowUp := up - atr2
        arrowUp
    else
        up := na(up[1]) ? maxLowPrice : math.max(maxLowPrice, up[1])
        up
    atrHigh := up + dev
    atrLow := up - dev
    atrLow
else
    if not na(trend[1]) and trend[1] != 1
        down := na(up[1]) ? up : up[1]
        arrowDown := down + atr2
        arrowDown
    else
        down := na(down[1]) ? minHighPrice : math.min(minHighPrice, down[1])
        down
    atrHigh := down + dev
    atrLow := down - dev
    atrLow

ht = trend == 0 ? up : down

var color buyColor = color.blue
var color sellColor = color.orange

htColor = trend == 0 ? buyColor : sellColor
htPlot = plot(ht, title='HalfTrend', linewidth=2, color=htColor)

buySignal = not na(arrowUp) and trend == 0 and trend[1] == 1
sellSignal = not na(arrowDown) and trend == 1 and trend[1] == 0

//EMA

srce = input.source(close, title="Source", group="EMA (Trend)")
emav = input.int(200, title="Length", group="EMA (Trend)")

ema = ta.ema(srce, emav)

//Superichi

tenkan_len  = input(9,'Tenkan',inline='tenkan', group="Superichi (Trend)")
tenkan_mult = input(2.,'',inline='tenkan', group="Superichi (Trend)")

kijun_len   = input(26,'Kijun',inline='kijun', group="Superichi (Trend)")
kijun_mult  = input(4,'',inline='kijun', group="Superichi (Trend)")

spanB_len   = input(52,'Senkou Span B',inline='span', group="Superichi (Trend)")
spanB_mult  = input(6, '', inline='span', group="Superichi (Trend)")

offset      = input(26,'Displacement', group="Superichi (Trend)")

avg(src,length,mult)=>
    atr = ta.atr(length)*mult
    up = hl2 + atr
    dn = hl2 - atr
    upper = 0.,lower = 0.
    upper := src[1] < upper[1] ? math.min(up,upper[1]) : up
    lower := src[1] > lower[1] ? math.max(dn,lower[1]) : dn
    
    os = 0,max = 0.,min = 0.
    os := src > upper ? 1 : src < lower ? 0 : os[1]
    spt = os == 1 ? lower : upper
    max := ta.cross(src,spt) ? math.max(src,max[1]) : os == 1 ? math.max(src,max[1]) : spt
    min := ta.cross(src,spt) ? math.min(src,min[1]) : os == 0 ? math.min(src,min[1]) : spt
    math.avg(max,min)

tenkan = avg(close,tenkan_len,tenkan_mult)
kijun = avg(close,kijun_len,kijun_mult)

senkouA = math.avg(kijun,tenkan)
senkouB = avg(close,spanB_len,spanB_mult)

tenkan_css = #2157f3
kijun_css = #ff5d00

cloud_a = color.new(color.teal,50)
cloud_b = color.new(color.red,50)

//Alert



mess_buyT = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(swingLow) + " â›”ï¸ \n" + "TP  " + str.tostring(((close-swingLow)*target_stop_ratio)+close) + " ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade."
mess_sellT = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(swingHigh) + " â›”ï¸ \n" + "TP  " + str.tostring(close-((swingHigh-close)*target_stop_ratio)) + " ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade."

mess_buyP = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingLow) + ",tp=" + str.tostring(((close-swingLow)*target_stop_ratio)+close) + ",risk=" + str.tostring(risk) + ""
mess_sellP = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingHigh) + ",tp=" + str.tostring(close-((swingHigh-close)*target_stop_ratio)) + ",risk=" + str.tostring(risk) + ""

mess_buyAT = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(atrBuy) + " â›”ï¸ \n" + "TP  " + str.tostring(((close-atrBuy)*target_stop_ratio)+close) + " ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade."
mess_sellAT = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(atrSell) + " â›”ï¸ \n" + "TP  " + str.tostring(close-((atrSell-close)*target_stop_ratio)) + " ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade."

mess_buyAP = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrBuy) + ",tp=" + str.tostring(((close-atrBuy)*target_stop_ratio)+close) + ",risk=" + str.tostring(risk) + ""
mess_sellAP = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrSell) + ",tp=" + str.tostring(close-((atrSell-close)*target_stop_ratio)) + ",risk=" + str.tostring(risk) + ""

mess_buyAMT = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(atrBuy) + " â›”ï¸ \n" + "TP1  " + str.tostring(((close-atrBuy)*target1)+close) + " ğŸ¯ \n" + "TP2  " + str.tostring(((close-atrBuy)*target2)+close) + "ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade. BE si TP1 touchÃ©"
mess_sellAMT = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(atrSell) + " â›”ï¸ \n" + "TP1  " + str.tostring(close-((atrSell-close)*target1)) + " ğŸ¯ \n" + "TP2  " + str.tostring(close-((atrSell-close)*target2)) + "ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade. BE si TP1 touchÃ©"

mess_buyAMP1 = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrBuy) + ",tp=" + str.tostring(((close-atrBuy)*target1)+close) + ",risk=" + str.tostring(risk/2) + ""
mess_buyAMP2 = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrBuy) + ",tp=" + str.tostring(((close-atrBuy)*target2)+close) + ",risk=" + str.tostring(risk/2) + ",betrigger=" + str.tostring(((((close-atrBuy)*target1)+close)-close)/getpips()) + ",beoffset=0"
mess_sellAMP1 = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrSell) + ",tp=" + str.tostring(close-((atrSell-close)*target1)) + ",risk=" + str.tostring(risk/2) + ""
mess_sellAMP2 = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(atrSell) + ",tp=" + str.tostring(close-((atrSell-close)*target2)) + ",risk=" + str.tostring(risk/2) + ",betrigger=" + str.tostring((close-(close-((atrSell-close)*target1)))/getpips()) + ",beoffset=0"

//é€™æ®µä»£ç¢¼æŒ‡ç¤ºäº¤æ˜“è»Ÿä»¶é€²è¡Œè³£å‡ºæ“ä½œï¼Œä¸¦æä¾›äº†äº¤æ˜“å•†å“ï¼Œç›®æ¨™åˆ©æ½¤ï¼Œé¢¨éšªå€¼ï¼Œä»¥åŠå…¶ä»–é‡è¦åƒæ•¸çš„ä¿¡æ¯ã€‚
//ä»¥ä¸‹æ˜¯ä»£ç¢¼ä¸­æ¯å€‹åƒæ•¸çš„æ„ç¾©ï¼š
//ID äº¤æ˜“å–®è™Ÿ
//syminfo.ticker:äº¤æ˜“å•†å“åç¨±ï¼ˆä¾‹å¦‚è²¨å¹£å°ï¼‰
//atrSell:äº¤æ˜“ç­–ç•¥ä½¿ç”¨çš„å¹³å‡çœŸå¯¦æ³¢å¹…(ATR)å€¼
//close:äº¤æ˜“å•†å“çš„ç•¶å‰æ”¶ç›¤åƒ¹æ ¼
//target2:è³£å‡ºçš„ç›®æ¨™åˆ©æ½¤
//risk:äº¤æ˜“çš„é¢¨éšªå€¼ é™¤ä»¥2ä»¥è¨ˆç®—æŠ•è³‡é‡‘é¡
//target1:è²·å…¥çš„ç›®æ¨™åˆ©æ½¤
//getpips:äº¤æ˜“å•†å“çš„åƒ¹æ ¼æ³¢å‹•(pips)
//beoffset:äº¤æ˜“çš„ä¿è­‰é‡‘åç§»é‡ï¼Œ è¨­ç½®ç‚º0ã€‚
//é€™æ®µä»£ç¢¼æŒ‡ç¤ºäº¤æ˜“è»Ÿä»¶é€²è¡Œè³£å‡ºæ“ä½œï¼Œä¸¦æä¾›äº†äº¤æ˜“å•†å“ï¼Œç›®æ¨™åˆ©æ½¤ï¼Œé¢¨éšªå€¼ï¼Œä»¥åŠå…¶ä»–é‡è¦åƒæ•¸çš„ä¿¡æ¯ã€‚


mess_buyMT = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(swingLow) + " â›”ï¸ \n" + "TP1  " + str.tostring(((close-swingLow)*target1)+close) + " ğŸ¯ \n" + "TP2  " + str.tostring(((close-swingLow)*target2)+close) + "ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade. BE si TP1 touchÃ©"                                                                                 
mess_sellMT = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n \n" + "Prix d'entrÃ©e  " + str.tostring(close) + "\n" + "SL  " + str.tostring(swingHigh) + " â›”ï¸ \n" + "TP1  " + str.tostring(close-((swingHigh-close)*target1)) + " ğŸ¯ \n" + "TP2  " + str.tostring(close-((swingHigh-close)*target2)) + "ğŸ¯ \n \n" + "âš ï¸ Avertissement : Respectez votre money management, risquez seulement " + str.tostring(risk) + "% de votre capital sur ce trade. BE si TP1 touchÃ©"

mess_buyMP1 = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingLow) + ",tp=" + str.tostring(((close-swingLow)*target1)+close) + ",risk=" + str.tostring(risk/2) + ""
mess_buyMP2 = "" + str.tostring(ID) + ",buy," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingLow) + ",tp=" + str.tostring(((close-swingLow)*target2)+close) + ",risk=" + str.tostring(risk/2) + ",betrigger=" + str.tostring(((((close-swingLow)*target1)+close)-close)/getpips()) + ",beoffset=0"
mess_sellMP1 = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingHigh) + ",tp=" + str.tostring(close-((swingHigh-close)*target1)) + ",risk=" + str.tostring(risk/2) + ""
mess_sellMP2 = "" + str.tostring(ID) + ",sell," + str.tostring(syminfo.ticker) + ",sl=" + str.tostring(swingHigh) + ",tp=" + str.tostring(close-((swingHigh-close)*target2)) + ",risk=" + str.tostring(risk/2) + ",betrigger=" + str.tostring((close-(close-((swingHigh-close)*target1)))/getpips()) + ",beoffset=0"

// Strategy
    
float risk_long = na
float risk_short = na
float stopLoss = na
float takeProfit1 = na
float takeProfit2 = na
float entry_price = na
bool longcondition = na
bool shortcondition = na

if trendA == "Superichi"
    longcondition := buySignal and close > senkouA[26] and senkouA[26] > senkouB[26]
    shortcondition := sellSignal and close < senkouA[26] and senkouA[26] < senkouB[26]
if trendA == "EMA"   
    longcondition := buySignal and close > ema
    shortcondition := sellSignal and close < ema

risk_long := risk_long[1]
risk_short := risk_short[1]

lotB = (strategy.equity*riskt-strategy.equity)/(close - swingLow)
lotS = (strategy.equity*riskt-strategy.equity)/(swingHigh - close)
    
lotB1 = (strategy.equity*riskt-strategy.equity)/(close - atrBuy)
lotS1 = (strategy.equity*riskt-strategy.equity)/(atrSell - close)

if typeSL == "ATR"

    if typeTP == "Multiple Target"
    //è©²ç­–ç•¥æ˜¯åœ¨æ»¿è¶³æŸäº›æ¢ä»¶æ™‚åœ¨å¤šå€‹ç›®æ¨™ä¸Šå»ºç«‹å¤šé ­é ­å¯¸ï¼Œä¾‹å¦‚ç­–ç•¥çš„é ­å¯¸è¦æ¨¡ç‚ºé›¶ã€å¤šé ­æ¢ä»¶ç‚ºçœŸä»¥åŠåœ¨äº¤æ˜“çª—å£å…§ã€‚ 
    //è¦é¡¯ç¤ºçš„é€šçŸ¥å°‡å–æ±ºæ–¼è®Šé‡â€œtlpcâ€çš„å€¼ã€‚ å¦‚æœâ€œtlpcâ€æ˜¯â€œTelegramâ€  é€šçŸ¥æ¶ˆæ¯å°‡æ˜¯â€œmess_buyAMTâ€  å¦‚æœâ€œtlpcâ€æ˜¯â€œPineConnectorâ€  é€šçŸ¥æ¶ˆæ¯å°‡æ˜¯â€œmess_buyAMP1â€ã€‚ æ­¤å¤–å¦‚æœâ€œtlpcâ€æ˜¯â€œPineConnectorâ€
    //å°‡ä»¥â€œalert.freq_once_per_bar_closeâ€çš„é »ç‡ç™¼é€æ¶ˆæ¯ç‚ºâ€œmess_sellAMP2â€çš„è­¦å ±ã€‚
    
        if strategy.position_size == 0 and longcondition and inTradeWindow 
            risk_long := (close - atrBuy) / close
            minp = close - atrBuy
            
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAMT, when = minp > security)
                
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAMP1, when = minp > security)
                    alert(mess_sellAMP2, alert.freq_once_per_bar_close)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAMT)
                
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAMP1)
                    alert(mess_sellAMP2, alert.freq_once_per_bar_close)
        
        if strategy.position_size == 0 and shortcondition and inTradeWindow 
            risk_short := (atrSell - close) / close 
            minp = atrSell - close
            
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAMT, when = minp > security)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAMP1, when = minp > security)
                    alert(mess_sellAMP2, alert.freq_once_per_bar_close)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAMT)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAMP1)
                    alert(mess_sellAMP2, alert.freq_once_per_bar_close)
    
    if typeTP == "R:R"
    
        if strategy.position_size == 0 and longcondition and inTradeWindow 
            risk_long := (close - atrBuy) / close
            minp = close - atrBuy
            
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAT, when = minp > security)
                
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAP, when = minp > security)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAT)
                
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB1, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyAP)
        
        if strategy.position_size == 0 and shortcondition and inTradeWindow 
            risk_short := (atrSell - close) / close 
            minp = atrSell - close
         
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAT, when = minp > security)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAP, when = minp > security)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAT)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS1, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellAP)
    
if typeSL == "Swing"

    if typeTP == "Multiple Target"
    
        if strategy.position_size == 0 and longcondition and inTradeWindow 
            risk_long := (close - swingLow) / close
            minp = close - swingLow
            
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyMT, when = minp > security)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyMP1, when = minp > security)
                    alert(mess_buyMP2, alert.freq_once_per_bar_close)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyMT)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyMP1)
                    alert(mess_buyMP2, alert.freq_once_per_bar_close)
       
        if strategy.position_size == 0 and shortcondition and inTradeWindow 
            risk_short := (swingHigh - close) / close  
            minp = swingHigh - close
            
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellMT, when = minp > security)
                        
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellMP1, when = minp > security)
                    alert(mess_sellMP2, alert.freq_once_per_bar_close)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellMT)
                        
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellMP1)
                    alert(mess_sellMP2, alert.freq_once_per_bar_close)
                    
    if typeTP == "R:R"

        if strategy.position_size == 0 and longcondition and inTradeWindow 
            risk_long := (close - swingLow) / close
            minp = close - swingLow
        
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyT, when = minp > security)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyP, when = minp > security)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyT)
                    
                if tlpc == "PineConnector" 
                    strategy.entry("long", strategy.long, qty=lotB, comment="Buy " + str.tostring(close) + "", alert_message = mess_buyP)
       
        if strategy.position_size == 0 and shortcondition and inTradeWindow 
            risk_short := (swingHigh - close) / close  
            minp = swingHigh - close
  
            if _x 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellT, when = minp > security)
                        
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellP, when = minp > security)
            else 
                if tlpc == "Telegram" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellT)
                        
                if tlpc == "PineConnector" 
                    strategy.entry("short", strategy.short, qty=lotS, comment="Sell " + str.tostring(close) + "", alert_message = mess_sellP)
    
if typeTP == "Multiple Target"

    if tlpc == "Telegram" 
    
        if strategy.position_size > 0
    
            stopLoss := strategy.position_avg_price * (1 - risk_long)
            takeProfit1 := strategy.position_avg_price * (1 + target1 * risk_long)
            takeProfit2 := strategy.position_avg_price * (1 + target2 * risk_long)
            entry_price := strategy.position_avg_price
            mess_profit1 = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "TP1 TouchÃ© âœ… +" + str.tostring(risk*target1) + "% " 
            strategy.exit("Exit 1", "long", limit = takeProfit1, qty_percent=50, comment_profit = "TP1 âœ…", alert_profit = mess_profit1)
            
            if ta.crossover(high, takeProfit1)
                mess_profit2 = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "TP2 TouchÃ© âœ… +" + str.tostring(risk*target2) + "% " 
                mess_be = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "BE â"
                strategy.exit("Exit 2", "long", stop = entry_price, limit = takeProfit2, qty_percent = 100, comment_profit = "TP2 âœ…", comment_loss = "BE â", alert_profit = mess_profit2)
            else 
                mess_loss = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "SL TouchÃ© âŒ -" + str.tostring(risk) + "% " 
                strategy.exit("Exit 1", "long", stop = stopLoss, qty_percent = 100, comment_loss = "SL âŒ", alert_loss = mess_loss)
        
        if strategy.position_size < 0
    
            stopLoss := strategy.position_avg_price * (1 + risk_short)
            takeProfit1 := strategy.position_avg_price * (1 - target1 * risk_short)
            takeProfit2 := strategy.position_avg_price * (1 - target2 * risk_short)
            entry_price := strategy.position_avg_price
            mess_profit1 = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "TP1 TouchÃ© âœ… +" + str.tostring(risk*target1) + "% " 
            strategy.exit("Exit 1", "short", limit = takeProfit1, qty_percent = 50, comment_profit = "TP1 âœ…", alert_profit = mess_profit1)
            
            if ta.crossunder(low, takeProfit1)
                mess_profit2 = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "TP2 TouchÃ© âœ… +" + str.tostring(risk*target2) + "% " 
                mess_be = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "BE â"
                strategy.exit("Exit 2", "short", stop = entry_price, limit = takeProfit2, qty_percent = 100, comment_profit = "TP2 âœ…", comment_loss = "BE â", alert_profit = mess_profit2)
            else 
                mess_loss = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "SL TouchÃ© âŒ -" + str.tostring(risk) + "% " 
                strategy.exit("Exit 1", "short", stop = stopLoss, qty_percent = 100, comment_loss = "SL âŒ", alert_loss = mess_loss)
                
    if tlpc == "PineConnector" 
        
        if strategy.position_size > 0

            stopLoss := strategy.position_avg_price * (1 - risk_long)
            takeProfit1 := strategy.position_avg_price * (1 + target1 * risk_long)
            takeProfit2 := strategy.position_avg_price * (1 + target2 * risk_long)
            entry_price := strategy.position_avg_price
            strategy.exit("Exit 1", "long", limit = takeProfit1, qty_percent=50, comment_profit = "TP1 âœ…")
            
            if ta.crossover(high, takeProfit1)
                strategy.exit("Exit 2", "long", stop = entry_price, limit = takeProfit2, qty_percent = 100, comment_profit = "TP2 âœ…", comment_loss = "BE â")
            else 
                strategy.exit("Exit 1", "long", stop = stopLoss, qty_percent = 100, comment_loss = "SL âŒ")
    
        if strategy.position_size < 0
    
            stopLoss := strategy.position_avg_price * (1 + risk_short)
            takeProfit1 := strategy.position_avg_price * (1 - target1 * risk_short)
            takeProfit2 := strategy.position_avg_price * (1 - target2 * risk_short)
            entry_price := strategy.position_avg_price
            strategy.exit("Exit 1", "short", limit = takeProfit1, qty_percent = 50, comment_profit = "TP1 âœ…")
            
            if ta.crossunder(low, takeProfit1)
                strategy.exit("Exit 2", "short", stop = entry_price, limit = takeProfit2, qty_percent = 100, comment_profit = "TP2 âœ…", comment_loss = "BE â")
            else 
                strategy.exit("Exit 1", "short", stop = stopLoss, qty_percent = 100, comment_loss = "SL âŒ")
            
if typeTP == "R:R"

    if strategy.position_size > 0

        stopLoss := strategy.position_avg_price * (1 - risk_long)
        takeProfit1 := strategy.position_avg_price * (1 + target_stop_ratio * risk_long)
        entry_price := strategy.position_avg_price
        
        if tlpc == "Telegram" 
            mess_profit = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "TP TouchÃ© âœ… +" + str.tostring(risk*target_stop_ratio) + "% " 
            mess_loss = "ğŸ“ˆ  ğ—”ğ—–ğ—›ğ—”ğ—§  ğŸ”µ  " + str.tostring(syminfo.ticker) + "\n" + "SL TouchÃ© âŒ -" + str.tostring(risk) + "% " 
            strategy.exit("Exit long", "long", stop = stopLoss, limit = takeProfit1, comment_profit="TP âœ…", comment_loss="SL âŒ", alert_profit = mess_profit, alert_loss = mess_loss)
        
        if tlpc == "PineConnector" 
            strategy.exit("Exit long", "long", stop = stopLoss, limit = takeProfit1, comment_profit="TP âœ…", comment_loss="SL âŒ")
            
    if strategy.position_size < 0

        stopLoss := strategy.position_avg_price * (1 + risk_short) 
        takeProfit1 := strategy.position_avg_price * (1 - target_stop_ratio * risk_short) 
        entry_price := strategy.position_avg_price
        
        if tlpc == "Telegram" 
            mess_profit = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "TP TouchÃ© âœ… +" + str.tostring(risk*target_stop_ratio) + "% " 
            mess_loss = "ğŸ“‰  ğ—©ğ—˜ğ—¡ğ—§ğ—˜  ğŸ”´  " + str.tostring(syminfo.ticker) + "\n" + "SL TouchÃ© âŒ -" + str.tostring(risk) + "% " 
            strategy.exit("Exit short", "short", stop = stopLoss, limit = takeProfit1, comment_profit="TP âœ…" , comment_loss="SL âŒ", alert_profit = mess_profit, alert_loss = mess_loss)           
            
        if tlpc == "PineConnector" 
            strategy.exit("Exit short", "short", stop = stopLoss, limit = takeProfit1, comment_profit="TP âœ…" , comment_loss="SL âŒ")         
        
//plot

trendema = trendA == "EMA" ? ema : na
plot(trendema, title="EMA", color=color.white, linewidth=2)

trendsuperA = trendA == "Superichi" ? senkouA : na 
trendsuperB = trendA == "Superichi" ? senkouB : na 
A = plot(trendsuperA,'Senkou Span A', na, offset=offset-1)
B = plot(trendsuperB,'Senkou Span B', na, offset=offset-1)
fill(A,B,senkouA > senkouB ? cloud_a : cloud_b)

plotshape(showArrows and buySignal ? atrLow : na, title='Arrow Up', style=shape.triangleup, location=location.absolute, size=size.tiny, color=color.new(buyColor, 0))
plotshape(showArrows and sellSignal ? atrHigh : na, title='Arrow Down', style=shape.triangledown, location=location.absolute, size=size.tiny, color=color.new(sellColor, 0))

exswingH = typeSL == "Swing" ? swingHigh : na
exswingL = typeSL == "Swing" ? swingLow : na
plot(exswingH, color=color.new(color.white, 60), style=plot.style_cross, title='Swing High')
plot(exswingL, color=color.new(color.white, 60), style=plot.style_cross, title='Swing Low')

exatrS = typeSL == "ATR" ? atrSell : na
exatrB = typeSL == "ATR" ? atrBuy : na
plot(exatrS, color=color.new(color.white, 60), title='ATR')
plot(exatrB, color=color.new(color.white, 60), title='ATR')

p_ep = plot(entry_price, color=color.new(color.white, 0), linewidth=2, style=plot.style_linebr, title='entry price')
p_sl = plot(stopLoss, color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr, title='stopLoss')
p_tp2 = plot(takeProfit2, color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr, title='takeProfit1')
p_tp1 = plot(takeProfit1, color=color.new(#52F071, 0), linewidth=1, style=plot.style_linebr, title='takeProfit2')
fill(p_sl, p_ep, color.new(color.red, transp=85))
fill(p_tp2, p_ep, color.new(color.green, transp=85))
fill(p_tp1, p_ep, color.new(#52F071, transp=85))

colorresult = strategy.netprofit > 0 ? color.green : color.red	
profitprc = strategy.netprofit / strategy.initial_capital * 100
periodzone = (backtestEndDate - backtestStartDate) / 3600 / 24 / 1000

var tbl = table.new(position.top_right, 4, 2, border_width=3)

table.cell(tbl, 0, 0, "Symbole",  bgcolor = #9B9B9B, width = 6, height = 6)
table.cell(tbl, 1, 0, "Net Profit", bgcolor = #9B9B9B, width = 6, height = 6)
table.cell(tbl, 2, 0, "Trades", bgcolor = #9B9B9B, width = 6, height = 6)
table.cell(tbl, 3, 0, "Period",  bgcolor = #9B9B9B, width = 6, height = 6)
    
table.cell(tbl, 0, 1, str.tostring(syminfo.ticker),  bgcolor = #E8E8E8, width = 6, height = 6)
table.cell(tbl, 1, 1, str.tostring(profitprc, format.mintick) + " %", bgcolor = colorresult,   width = 6, height = 6)
table.cell(tbl, 2, 1, str.tostring(strategy.closedtrades), bgcolor = colorresult,   width = 6, height = 6)
table.cell(tbl, 3, 1, str.tostring(periodzone) + " day", bgcolor = colorresult,   width = 6, height = 6)
